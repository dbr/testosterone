"""Main function a la Guido:

    http://www.artima.com/weblogs/viewpost.jsp?thread=4829

"""
import getopt
import os
import sys

from testosterone.cli.reporters import detail, summarize

os.environ['PYTHONTESTING'] = 'testosterone'
WINDOWS = 'win' in sys.platform


class Usage(Exception):
    def __init__(self, msg):
        self.msg = msg


def main(argv=None):
    if argv is None:
        argv = sys.argv
    try:
        try:
            short = "iInNqQrRsSx:"
            long_ = [ "interactive","scripted"
                    , "run","find"
                    , "quiet","verbose"
                    , "recursive","flat"
                    , "summary","detail"
                    , "stopwords="
                     ]
            opts, args = getopt.getopt(argv[1:], short, long_)
        except getopt.error, msg:
            raise Usage(msg)

        interactive = True  # -i
        run = True          # -n
        quiet = True        # -q
        recursive = True    # -r
        summary = True      # -s
        stopwords = []      # -x

        for opt, value in opts:
            if opt in ('-I', '--scripted'):
                interactive = False
            elif opt in ('-N', '--find'):
                run = False
            elif opt in ('-Q', '--verbose'):
                quiet = False
            elif opt in ('-R', '--flat'):
                recursive = False
            elif opt in ('-S', '--detail'):
                summary = False
            elif opt in ('-x', '--stopwords'):
                stopwords = value.split(',')

        if not args:
            raise Usage("No module specified.")
        base = args[0]

        if WINDOWS or not interactive:
            if summary:
                report = summarize(base, quiet, recursive, run, stopwords)
            else:
                report = detail(base)
            sys.stdout.write(report)
        else:
            from testosterone.interactive import CursesInterface
            CursesInterface(base, stopwords)

    except Usage, err:
        print >> sys.stderr, err.msg
        print >> sys.stderr, "'man 1 testosterone' for instructions."
        return 2
