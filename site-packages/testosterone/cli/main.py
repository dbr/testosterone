"""Main function a la Guido:

    http://www.artima.com/weblogs/viewpost.jsp?thread=4829

"""
import getopt
import sys

from testosterone.cli.reporters import detail, summarize


WINDOWS = 'win' in sys.platform


class Usage(Exception):
    def __init__(self, msg):
        self.msg = msg


def main(argv=None):
    if argv is None:
        argv = sys.argv
    try:
        try:
            short = "iInNt:x:"
            long_ = [ "interactive","scripted"
                    , "run","find"
                    , "testcase=","TestCase="
                    , "stopwords="
                     ]
            opts, args = getopt.getopt(argv[1:], short, long_)
        except getopt.error, msg:
            raise Usage(msg)

        interactive = True  # -i
        run = True          # -n
        stopwords = []      # -x
        testcase = None     # -t

        for opt, value in opts:
            if opt in ('-I', '--scripted'):
                interactive = False
            elif opt in ('-N', '--find'):
                run = False
            elif opt in ('-x', '--stopwords'):
                stopwords = value.split(',')
            elif opt in ('-t', '--testcase', '--TestCase'):
                testcase = value

        if len(args) == 1:
            module = args[0]
        else:
            raise Usage("Please specify a module.")

        if WINDOWS or not interactive:
            if testcase is None:
                report = summarize(module, run, stopwords)
            else:
                report = detail(module, testcase)
            sys.stdout.write(report)
        else:
            from testosterone.interactive import CursesInterface
            CursesInterface(module, stopwords)

    except Usage, err:
        print >> sys.stderr, err.msg
        print >> sys.stderr, "'man 1 testosterone' for instructions."
        return 2
